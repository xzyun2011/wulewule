# ğŸ’æ‚Ÿäº†æ‚Ÿäº†ğŸ’ â€” ã€Šé»‘ç¥è¯ï¼šæ‚Ÿç©ºã€‹AIåŠ©æ‰‹

<br />
<!-- PROJECT LOGO -->

<p align="center">
  <a href="https://github.com/xzyun2011/wulewule/">
    <img src="./assets/sd_wulewule.webp" alt="Logo" width="30%">
  </a>



<h3 align="center"> æ‚Ÿäº†æ‚Ÿäº†</h3>
  <p align="center">
    <br />
    <a href="https://github.com/xzyun2011/wulewule/">æŸ¥çœ‹Demo</a>
    Â·
    <a href="https://github.com/xzyun2011/wulewule/issues">æŠ¥å‘ŠBug & æå‡ºæ–°ç‰¹æ€§</a>
  </p>



## ğŸ“œ å‰è¨€

å›½äº§3Aæ¸¸æˆã€Šé»‘ç¥è¯ï¼šæ‚Ÿç©ºã€‹è‡ªå‘å¸ƒä»¥æ¥ï¼Œä»¥å…¶ç²¾ç¾ç»ä¼¦çš„ç”»é¢ã€æµç•…è‡ªå¦‚çš„æˆ˜æ–—æœºåˆ¶ã€ç²¾å¿ƒé›•ç¢çš„è®¾è®¡ã€æ·±åšçš„æ–‡åŒ–åº•è•´ç­‰ï¼Œåœ¨å…¨ç½‘å¼•å‘çƒ­æ½®ã€‚å¼€å‘è¿™æ¬¾â€œæ‚Ÿäº†æ‚Ÿäº†â€AIå°åŠ©æ‰‹çš„åˆè¡·ï¼Œæ˜¯æƒ³å¸®åŠ©ç©å®¶æ·±å…¥æ¢ç´¢æ¸¸æˆçš„æ–‡åŒ–å†…æ¶µï¼Œä¸°å¯Œæ¸¸æˆä½“éªŒã€‚é€šè¿‡è§£ææ¸¸æˆä¸­çš„æ•…äº‹æƒ…èŠ‚ã€è§’è‰²æ¸Šæºã€ä¸åŸè‘—çš„å·§å¦™è”ç³»ã€æ¸¸æˆéšè—ç»†èŠ‚ä»¥åŠæœ‰è¶£çš„å½©è›‹ç­‰å†…å®¹ï¼Œè®©ç©å®¶æ›´äº†è§£æ¸¸æˆèƒŒåçš„ä¸­å›½ä¼ ç»Ÿæ–‡åŒ–ï¼Œä¸ºç©å®¶åœ¨é…£ç•…æ·‹æ¼“çš„æˆ˜æ–—ä¹‹ä½™ï¼Œå¸¦æ¥ä¸€åœºç²¾ç¥ä¸Šçš„ç››å®´ã€‚æ­¤å¤–ï¼Œå°åŠ©æ‰‹è¿˜æä¾›è¯¦å°½çš„æ¸¸æˆæ”»ç•¥ï¼ŒåŠ©åŠ›ç©å®¶è½»æ¾é€šå…³ï¼Œå°½äº«æ¸¸æˆä¹è¶£ã€‚

æ‚Ÿäº†æ‚Ÿäº†çš„æ¨¡å‹ä½¿ç”¨ [xtuner](https://github.com/InternLM/xtuner)åœ¨ [InternLM2.5](https://github.com/InternLM/InternLM) å¾®è°ƒå¾—åˆ°ï¼Œ é¦–å…ˆåœ¨ä¸€äº›ç½‘ç»œæ•°æ®ï¼ˆå¦‚ã€Šè¥¿æ¸¸è®°ã€‹ä¸­è‹±æ–‡ç‰ˆã€ã€Šæ‚Ÿç©ºä¼ ã€‹ç­‰ï¼‰ä¸Šè¿›è¡Œ**å¢é‡é¢„è®­ç»ƒ**ï¼Œå†åŸºäºRAGç”Ÿæˆçš„å‡†ç¡®çš„é—®ç­”å¯¹æ•°æ®é›†ï¼ŒåŸºäºæ­¤æ•°æ®é›†è¿›è¡Œ**QLoRAæŒ‡ä»¤å¾®è°ƒ**ã€‚éƒ¨ç½²æ—¶é›†æˆäº†**RAG**å’Œ**LMDeploy åŠ é€Ÿæ¨ç†**

**é¡¹ç›®äº®ç‚¹æ€»ç»“ï¼š**

1. ğŸ“Š åŸºäºRAGåˆ¶ä½œå‡†ç¡®å®æ—¶çš„æ–°çŸ¥è¯†æ•°æ®é›†
2. ğŸ“š RAG æ£€ç´¢å¢å¼ºç”Ÿæˆå›ç­”
3. ğŸš€ KV cache + Turbomind æ¨ç†åŠ é€Ÿ



## ğŸ¥ æ•ˆæœå›¾

<video src="assets/wulewulev1_7b_4bit.mp4"></video>



## ğŸ—‚ï¸ ç›®å½•
- [ğŸ“œ å‰è¨€](#-å‰è¨€)
- [ğŸ¥ å›¾æ•ˆæœå›¾](#-æ•ˆæœå›¾)
- [ğŸ“Š æ¡†æ¶å›¾](#-æ¡†æ¶å›¾)
- [ğŸ§© Model Zoo](#-model-zoo)
- [ğŸš€ å¿«é€Ÿä½¿ç”¨](#-å¿«é€Ÿä½¿ç”¨)
  - [ğŸ’» æœ¬åœ°éƒ¨ç½²](#-æœ¬åœ°éƒ¨ç½²)
  - [ğŸŒ åœ¨çº¿ä½“éªŒ](#-åœ¨çº¿ä½“éªŒ)
- [ğŸ“– è¯¦ç»†æŒ‡å—](#-è¯¦ç»†æŒ‡å—)
  - [ğŸ” æ•°æ®é›†åˆ¶ä½œ](#-æ•°æ®é›†åˆ¶ä½œ)
    - [ğŸ“š å¢é‡é¢„è®­ç»ƒæ•°æ®](#-å¢é‡é¢„è®­ç»ƒæ•°æ®)
    - [ğŸ¤” è‡ªæˆ‘è®¤çŸ¥æ•°æ®](#-è‡ªæˆ‘è®¤çŸ¥æ•°æ®)
    - [ğŸ’¬ æŒ‡ä»¤å¾®è°ƒæ•°æ®](#-æŒ‡ä»¤å¾®è°ƒæ•°æ®)
  - [ğŸ”„ æ¨¡å‹è®­ç»ƒ](#-æ¨¡å‹è®­ç»ƒ)
  - [ğŸ¨ æ¨¡å‹é‡åŒ–](#-æ¨¡å‹é‡åŒ–)
  - [ğŸ” RAG(æ£€ç´¢å¢å¼ºç”Ÿæˆ)](#-ragæ£€ç´¢å¢å¼ºç”Ÿæˆ)
- [ğŸ“… å¼€å‘è®¡åˆ’](#-å¼€å‘è®¡åˆ’)
  - [ğŸŒŸ åˆç‰ˆåŠŸèƒ½](#-åˆç‰ˆåŠŸèƒ½)
  - [ğŸ¤– åç»­å¤šæ¨¡æ€ç‰ˆæœ¬](#-åç»­å¤šæ¨¡æ€ç‰ˆæœ¬)
- [ğŸ™ è‡´è°¢](#-è‡´è°¢)
- [âš ï¸ å…è´£å£°æ˜](#-å…è´£å£°æ˜)

---


## ğŸ“Š æ¡†æ¶å›¾

![](assets/æ¡†æ¶å›¾.png)

## ğŸ§© Model Zoo

| æ¨¡å‹                        | åŸºåº§                  | ç±»å‹                       | ModelScope(HF)                                               | OpenXLab(HF)                                                 |
| --------------------------- | --------------------- | -------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| wulewule_v1_1_8b            | internlm2_5_chat_1_8b | é¢„è®­ç»ƒ+QLoRAå¾®è°ƒ           | [wulewule_v1_1_8b](https://modelscope.cn/models/xzyun2011/wulewule_v1_1_8b) | [wulewule_v1_1_8b](https://openxlab.org.cn/models/detail/xzyun2011/wulewule_v1_1_8b) |
| wulewule_v1_1_8b-w4a16-4bit | internlm2_5_chat_1_8b | é¢„è®­ç»ƒ+QLoRAå¾®è°ƒ+w4a16é‡åŒ– | [wulewule_v1_1_8b-w4a16-4bit](https://modelscope.cn/models/xzyun2011/wulewule_v1_1_8b-w4a16-4bit) | [wulewule_v1_1_8b-w4a16-4bit](https://openxlab.org.cn/models/detail/xzyun2011/wulewule_v1_1_8b-w4a16-4bit) |
| wulewule_v1_7b              | internlm2_5_chat_7b   | é¢„è®­ç»ƒ+QLoRAå¾®è°ƒ           | [wulewule_v1_7b](https://modelscope.cn/models/xzyun2011/wulewule_v1_7b) | [wulewule_v1_7b](https://openxlab.org.cn/models/detail/xzyun2011/wulewule_v1_7b) |
| wulewule_v1_7b-w4a16-4bit   | internlm2_5_chat_7b   | é¢„è®­ç»ƒ+QLoRAå¾®è°ƒ+w4a16é‡åŒ– | [wulewule_v1_7b-w4a16-4bit](https://modelscope.cn/models/xzyun2011/wulewule_v1_7b-w4a16-4bit) | [wulewule_v1_7b-w4a16-4bit](https://openxlab.org.cn/models/detail/xzyun2011/wulewule_v1_7b-w4a16-4bit) |



## ğŸš€ å¿«é€Ÿä½¿ç”¨

### ğŸ’» æœ¬åœ°éƒ¨ç½²

```shell
git clone https://github.com/xzyun2011/wulewule.git
cd wulewule
conda create -n wulewule python=3.10.0 -y
conda activate wulewule
conda install pytorch==2.1.2 torchvision==0.16.2 torchaudio==2.1.2 pytorch-cuda=12.1 -c pytorch -c nvidia
pip install -r requirements.txt
apt-get install git-lfs
streamlit run app.py
```

### ğŸŒ åœ¨çº¿ä½“éªŒ

åˆ¶ä½œä¸­...

wulewule_InternLM2-Chat-1_8ç‰ˆä½“éªŒåœ°å€ï¼šhttps://openxlab.org.cn/apps/detail/xzyun2011/wulewule_v1

## ğŸ“– è¯¦ç»†æŒ‡å—

### ğŸ” æ•°æ®é›†åˆ¶ä½œ

æ•°æ®åˆ¶ä½œä»£ç è®²è§£è§[æ•°æ®åˆ¶ä½œæµç¨‹](data/readme.md)ï¼Œä½¿ç”¨è„šæœ¬ç›´æ¥åˆ¶ä½œæ•°æ®é›†ï¼š

#### ğŸ“š å¢é‡é¢„è®­ç»ƒæ•°æ®

å°†ç½‘ç»œæ”¶é›†åˆ°çš„æ–‡æœ¬æ•°æ®åˆ‡åˆ†ï¼Œæ‰§è¡Œè„šæœ¬ï¼Œå¾—åˆ°`incremental_pretraining.jsonl`å¢é‡é¢„è®­ç»ƒæ•°æ®

```
conda activate wulewule
cd wulewule/data
python3 generate_incremental_pretraining.py --root-path ./ --save-path ./incremental_pretraining.jsonl
```

#### ğŸ¤” è‡ªæˆ‘è®¤çŸ¥æ•°æ®**

å°†`data_utils.py`ä¸­çš„"api_key"æ¢æˆè‡ªå·±çš„ï¼Œæ‰§è¡Œè„šæœ¬ï¼Œå°†å¾—åˆ°`self_cognition.jsonl`è‡ªæˆ‘è®¤çŸ¥æ•°æ®

```
python3 generate_selfcognition.py --save-path ./self_cognition.jsonl
```

#### ğŸ’¬ æŒ‡ä»¤å¾®è°ƒæ•°æ®**

å¼€å¯èŒ´é¦™è±†serveræœåŠ¡åï¼Œæ‰§è¡Œè„šæœ¬ï¼Œå°†å¾—åˆ°`huixiangdou_conversations.jsonl`å‡†ç¡®çš„é—®ç­”å¯¹æ•°æ®

```
python3 huixiangdou_rag_QA.py
```

### ğŸ”„ æ¨¡å‹è®­ç»ƒ

è®­ç»ƒé…ç½®ä»£ç è®²è§£è§[è®­ç»ƒé…ç½®](xtuner_config/readme.md)ï¼Œ
ğŸš¨å…¶ä¸­æœ‰ä¸ªå‚æ•°éœ€è¦æ³¨æ„ä¸€ä¸‹ï¼šaccumulative_counts = 1 #å•å¡è®­ç»ƒåˆ‡è®°æ”¹æˆ1ï¼Œä¸ç„¶ä¼šæœ‰é—®é¢˜ï¼ŒğŸš¨åˆ‡è®°åˆ‡è®°ï¼ï¼ï¼

å‘½ä»¤è¡Œç›´æ¥å¦‚ä¸‹æ“ä½œï¼š

**QLoRA+deepspeedè®­ç»ƒ**

```
#å¢é‡é¢„è®­ç»ƒ
xtuner train ./xtuner_config/pretrain/internlm2_5-1_8b-chat_pretrain.py  --work-dir ./pretrain --deepspeed deepspeed_zero1

#æŒ‡ä»¤å¾®è°ƒ
xtuner train ./xtuner_config/finetune/internlm2_5_chat_1_8b_qlora_wulewule_all_test.py  --work-dir ./finetune --deepspeed deepspeed_zero1
```

**æ¨¡å‹è½¬æ¢ + LoRA åˆå¹¶**

```
export MKL_SERVICE_FORCE_INTEL=1
export MKL_THREADING_LAYER=GNU
##æŒ‡ä»¤å¾®è°ƒä¸ºä¾‹å­ï¼Œå…ˆè·å–æœ€åä¿å­˜çš„ä¸€ä¸ªpthæ–‡ä»¶
pth_file=`ls -t ./finetune/internlm2_5_chat_1_8b_qlora_wulewule_all_test.py/*.pth | head -n 1| sed 's/:$//' `
# è½¬æ¢æ ¼å¼
xtuner convert pth_to_hf ./internlm2_5_chat_1_8b_qlora_wulewule_all_test.py ${pth_file} ./hf
# åˆå¹¶å‚æ•°
xtuner convert merge /root/models/internlm2_5-1_8b-chat ./hf /root/wulewule/models/wulewule_v1_1_8b --max-shard-size 2GB
```

### ğŸ¨ æ¨¡å‹é‡åŒ–

ä½¿ç”¨ä¸€ä¸‹å‘½ä»¤å¯¹æ¨¡å‹é‡‡å–w4a16é‡åŒ–ï¼Œæ›´å¤šæ“ä½œè¯·å‚è€ƒ[lmdeployå®˜ç½‘æ–‡æ¡£](https://lmdeploy.readthedocs.io/en/latest/)

```
lmdeploy lite auto_awq \
   /root/wulewule/models/wulewule_v1_1_8b \
  --calib-dataset 'ptb' \
  --calib-samples 128 \
  --calib-seqlen 2048 \
  --w-bits 4 \
  --w-group-size 128 \
  --batch-size 1 \
  --search-scale False \
  --work-dir /root/wulewule/models/wulewule_v1_1_8b-w4a16-4bit
```

**é‡åŒ–å‰åé€Ÿåº¦å¯¹æ¯”**

| Model                       | Toolkit              | Speed (words/s) |
| --------------------------- | -------------------- | --------------- |
| wulewule_v1_1_8b            | transformer          | 68.0986         |
| wulewule_v1_1_8b-w4a16-4bit | LMDeploy (Turbomind) | 667.8319        |

ä¿®æ”¹`configs/model_cfg.yaml`æ–‡ä»¶å¼€å¯åŸºäºlmdeployçš„w4a16-4bitæ¨¡å‹ï¼ˆé»˜è®¤å¼€å¯ï¼‰ï¼›`deploy/lmdeploy_model.py`é‡Œæ˜¯ä¸€ä¸ªç®€å•çš„demoï¼Œä¿®æ”¹é…ç½®åå¯ä»¥ç›´æ¥æ‰§è¡Œ

```
python3 deploy/lmdeploy_model.py
```

### ğŸ” RAG(æ£€ç´¢å¢å¼ºç”Ÿæˆ)

é»˜è®¤`data`ç›®å½•ä¸ºtxtæ•°æ®æºç›®å½•ï¼Œå¼€å¯RAGåï¼Œä¼šä½¿ç”¨bce-embedding-base_v1è‡ªåŠ¨å°†`data`ç›®å½•ä¸‹çš„txtæ•°æ®è½¬ä¸ºæ¢chromaå‘é‡åº“æ•°æ®ï¼Œå­˜æ”¾åœ¨`rag/chroma `ç›®å½•ä¸‹ï¼ˆå¦‚æœè¯¥ç›®å½•ä¸‹å·²æœ‰æ•°æ®åº“æ–‡ä»¶ï¼Œåˆ™è·³è¿‡æ•°æ®åº“åˆ›å»ºï¼‰ï¼Œç„¶åä½¿ç”¨bce-reranker-base_v1å¯¹æ£€ç´¢åˆ°çš„ä¿¡æ¯é‡æ’åºåï¼Œå°†é—®é¢˜å’Œä¸Šä¸‹æ–‡ä¸€èµ·ç»™æ¨¡å‹å¾—åˆ°æœ€ç»ˆè¾“å‡ºã€‚`rag/simple_rag.py`é‡Œæ˜¯ä¸€ä¸ªç®€å•çš„demoï¼Œå‚æ•°é…ç½®è§`configs/rag_cfg.yaml`ã€‚

RAGä»£ç è®²è§£è§[ragé…ç½®](rag/readme.md)ã€‚


## ğŸ“… å¼€å‘è®¡åˆ’

### ğŸŒŸ åˆç‰ˆåŠŸèƒ½

- [x] æ¸¸æˆè§’è‰²ã€èƒŒæ™¯æ•…äº‹ã€åŸè‘—è”ç³»ç­‰çŸ¥è¯†é—®ç­”åŠ©æ‰‹

- [x] ä½¿ç”¨RAGæ”¯æŒæ¸¸æˆæ”»ç•¥ã€èœå•ã€ç½‘ç»œæ¢—ç­‰æ–°é²œçŸ¥è¯†çš„æ›´æ–°

- [x] åŸºäºOpenXLabä½¿ç”¨LMDepolyå®ç°åˆç‰ˆdemoéƒ¨ç½²

- [ ] å¢åŠ historyè®°å¿†ï¼Œå¢åŠ æ ‡å‡†æµ‹è¯•é›†ï¼Œopencompassè¯„ä¼°æ¨¡å‹æ€§èƒ½

### ğŸ¤– åç»­å¤šæ¨¡æ€ç‰ˆæœ¬

- [ ] åŠ å…¥è¯­éŸ³å¤šæ¨¡æ€ï¼Œå¦‚ASRï¼ˆç”¨æˆ·è¯­éŸ³è¾“å…¥ï¼‰ã€TTSï¼ˆçŒ´å“¥è¯­éŸ³å›ç­”é—®é¢˜ï¼‰

- [ ] åŠ å…¥å›¾åƒç”Ÿæˆï¼Œæ¥å…¥åˆ«äººçš„[SD+LoRAæ¨¡å‹]( https://www.qpipi.com/73996/ )ï¼Œåˆ¤æ–­ç”¨æˆ·æ„å›¾ç”Ÿæˆå¯¹åº”promptçš„å¤©å‘½äºº

- [ ] åŠ å…¥éŸ³ä¹å¤šæ¨¡æ€ï¼Œæ¥ç±»ä¼¼[SUNO-AI](https://suno-ai.org/)ï¼Œç”Ÿæˆå¤å…¸é£æ ¼æ¸¸æˆé…ä¹


## ğŸ™ è‡´è°¢

éå¸¸æ„Ÿè°¢ä»¥ä¸‹è¿™äº›å¼€æºé¡¹ç›®ç»™äºˆæˆ‘ä»¬çš„å¸®åŠ©ï¼š

- [InternLM](https://github.com/InternLM/InternLM)
- [Xtuner](https://github.com/InternLM/xtuner)
- [Imdeploy](https://github.com/InternLM/lmdeploy)
- [InternlM-Tutorial](https://github.com/InternLM/Tutorial)
- [HuixiangDou](https://github.com/InternLM/HuixiangDou)
- [Streamer-Sales](https://github.com/PeterH0323/Streamer-Sales)

æœ€åæ„Ÿè°¢ä¸Šæµ·äººå·¥æ™ºèƒ½å®éªŒå®¤æ¨å‡ºçš„ä¹¦ç”ŸÂ·æµ¦è¯­å¤§æ¨¡å‹å®æˆ˜è¥ï¼Œä¸ºæˆ‘ä»¬çš„é¡¹ç›®æä¾›å®è´µçš„æŠ€æœ¯æŒ‡å¯¼å’Œå¼ºå¤§çš„ç®—åŠ›æ”¯æŒï¼

## âš ï¸ å…è´£å£°æ˜

**æœ¬é¡¹ç›®ç›¸å…³èµ„æºä»…ä¾›å­¦æœ¯ç ”ç©¶ä¹‹ç”¨ï¼Œä¸¥ç¦ç”¨äºå•†ä¸šç”¨é€”ã€‚** ä½¿ç”¨æ¶‰åŠç¬¬ä¸‰æ–¹ä»£ç çš„éƒ¨åˆ†æ—¶ï¼Œè¯·ä¸¥æ ¼éµå¾ªç›¸åº”çš„å¼€æºåè®®ã€‚æ¨¡å‹ç”Ÿæˆçš„å†…å®¹å—æ¨¡å‹è®¡ç®—ã€éšæœºæ€§å’Œé‡åŒ–ç²¾åº¦æŸå¤±ç­‰å› ç´ å½±å“ï¼Œæœ¬é¡¹ç›®ä¸å¯¹å…¶å‡†ç¡®æ€§ä½œå‡ºä¿è¯ã€‚å¯¹äºæ¨¡å‹è¾“å‡ºçš„ä»»ä½•å†…å®¹ï¼Œæœ¬é¡¹ç›®ä¸æ‰¿æ‹…ä»»ä½•æ³•å¾‹è´£ä»»ï¼Œäº¦ä¸å¯¹å› ä½¿ç”¨ç›¸å…³èµ„æºå’Œè¾“å‡ºç»“æœè€Œå¯èƒ½äº§ç”Ÿçš„ä»»ä½•æŸå¤±æ‰¿æ‹…è´£ä»»ã€‚æœ¬é¡¹ç›®ç”±ä¸ªäººåŠåä½œè€…ä¸šä½™æ—¶é—´å‘èµ·å¹¶ç»´æŠ¤ï¼Œå› æ­¤æ— æ³•ä¿è¯èƒ½åŠæ—¶å›å¤è§£å†³ç›¸åº”é—®é¢˜ã€‚
